{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://avocado.com/schemas/avocado-config/1.2.0.json",
  "title": "Avocado Configuration",
  "description": "Configuration schema for Avocado CLI avocado.yaml files. Defines project settings, build configurations, packages, and provisioning profiles for Avocado OS projects.",
  "type": "object",
  "properties": {
    "default_target": {
      "title": "Default target",
      "$ref": "#/definitions/target",
      "description": "The default target platform for the project. This target is used when building the project if no target is specified.",
      "examples": ["jetson-orin-nano-devkit"]
    },
    "supported_targets": {
      "title": "Supported targets",
      "oneOf": [
        {
          "type": "string",
          "enum": ["*"],
          "description": "Support all available targets."
        },
        {
          "type": "array",
          "items": {
            "$ref": "#/definitions/target"
          },
          "description": "List of specific supported target architectures."
        }
      ],
      "description": "Defines which targets are supported by this project. Use '*' to support all targets, or provide an array of specific target names to limit support.",
      "examples": ["*", ["raspberrypi4", "qemuarm64"]]
    },
    "src_dir": {
      "title": "Source directory",
      "type": "string",
      "description": "Path to the source directory relative to the configuration file. If not specified, defaults to the directory containing the configuration file. This is where your project source code is located.",
      "default": ".",
      "examples": ["."]
    },
    "distro": {
      "title": "Distribution configuration",
      "$ref": "#/definitions/distroConfig",
      "description": "Distribution-specific configuration for the Avocado OS project."
    },
    "runtimes": {
      "title": "Runtimes",
      "type": "object",
      "description": "Runtime configurations for different deployment scenarios. Each runtime can specify extensions, packages, and target-specific settings.",
      "patternProperties": {
        "^[a-zA-Z0-9_-]+$": {
          "$ref": "#/definitions/runtimeConfig"
        }
      },
      "additionalProperties": false,
      "examples": [
        {
          "dev": {
            "extensions": ["avocado-ext-dev", "avocado-ext-sshd-dev"],
            "packages": {
              "avocado-runtime": "*"
            }
          }
        }
      ]
    },
    "sdk": {
      "title": "SDK Configuration",
      "$ref": "#/definitions/sdkConfig",
      "description": "Configure the default Avocado SDK."
    },
    "provision_profiles": {
      "title": "Provisioning profiles",
      "type": "object",
      "description": "Provisioning profiles for deploying Avocado OS images to devices. Each profile can define different settings for development, production, or custom deployment scenarios.",
      "patternProperties": {
        "^[a-zA-Z0-9_-]+$": {
          "$ref": "#/definitions/provisionProfileConfig"
        }
      },
      "additionalProperties": false,
      "examples": [
        {
          "development": {
            "container_args": ["--device", "/dev/ttyUSB0"]
          }
        }
      ]
    },
    "extensions": {
      "title": "Extensions",
      "type": "object",
      "description": "Extension configurations for both local extensions (defined in this file) and remote extensions (fetched from package repositories, git, or local paths).",
      "patternProperties": {
        "^[a-zA-Z0-9_{}. -]+$": {
          "$ref": "#/definitions/extensionConfig"
        }
      },
      "additionalProperties": false,
      "examples": [
        {
          "example-rust": {
            "types": ["sysext", "confext"],
            "packages": {
              "example-rust-app": {
                "compile": "example-rust-app",
                "install": "example-rust-install.sh"
              }
            },
            "sdk": {
              "packages": {
                "nativesdk-rust": "*",
                "rust-cross-canadian-aarch64": "*",
                "nativesdk-cargo": "*"
              }
            }
          }
        }
      ]
    },
    "signing_keys": {
      "title": "Signing keys",
      "type": "array",
      "description": "Mapping of friendly names to signing key IDs. Acts as a local bridge between the config and the global signing keys registry.",
      "items": {
        "type": "object",
        "patternProperties": {
          "^[a-zA-Z0-9_-]+$": {
            "type": "string",
            "description": "Signing key ID (e.g., sha256-abc123)"
          }
        },
        "additionalProperties": false
      },
      "examples": [[{ "my-key": "sha256-abc123" }, { "other-key": "sha256-def456" }]]
    }
  },
  "additionalProperties": false,
  "definitions": {
    "version": {
      "title": "Version",
      "type": "string",
      "description": "A version string. Use '*' for any version, or a specific semantic version.",
      "examples": ["*", "1.0.0", "0.23.0"]
    },
    "versionRequirement": {
      "title": "Version requirement",
      "type": "string",
      "description": "Semantic version requirement string. Supports exact versions (e.g., '2.1.3'), minimum versions (e.g., '>=1.0.0'), ranges, and other semver patterns.",
      "examples": ["1.0.0", ">=1.0.0", "~1.2.0", "^2.0.0", "2.1.3"]
    },
    "target": {
      "title": "Target",
      "type": "string",
      "enum": [
        "imx8mp-evk",
        "imx91-frdm",
        "imx93-frdm",
        "imx93-evk",
        "qemuarm64",
        "qemux86-64",
        "reterminal",
        "reterminal-dm",
        "jetson-orin-nano-devkit",
        "raspberrypi4",
        "raspberrypi5"
      ],
      "description": "An identifier for the platform for Avocado OS builds and deployments.",
      "additionalProperties": false
    },
    "distroConfig": {
      "title": "Distribution configuration",
      "type": "object",
      "description": "Distribution-specific settings.",
      "properties": {
        "channel": {
          "title": "Channel",
          "type": "string",
          "description": "Distribution channel (e.g., 'apollo', 'blackbird').",
          "examples": ["apollo-edge", "blackbird-stable"]
        },
        "version": {
          "title": "Version",
          "type": "string",
          "description": "Distribution version string.",
          "examples": ["0.1.0"]
        }
      },
      "additionalProperties": false
    },
    "extensionSource": {
      "title": "Extension source",
      "type": "object",
      "description": "Source configuration for fetching a remote extension. Supports package repositories, git repositories, and local filesystem paths.",
      "oneOf": [
        {
          "type": "object",
          "title": "Package source",
          "description": "Extension from the Avocado package repository.",
          "properties": {
            "type": {
              "type": "string",
              "enum": ["package"],
              "description": "Source type: package repository."
            },
            "version": {
              "type": "string",
              "description": "Version to fetch (e.g., '0.1.0' or '*').",
              "examples": ["*", "1.0.0"]
            },
            "package": {
              "type": "string",
              "description": "Optional RPM package name (defaults to extension name if not specified).",
              "examples": ["avocado-bsp-raspberrypi4"]
            },
            "repo_name": {
              "type": "string",
              "description": "Optional custom repository name.",
              "examples": ["avocado-extras"]
            },
            "include": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Optional list of config sections to include from the remote extension. Supports dot-separated paths (e.g., 'provision_profiles.tegraflash') and wildcards (e.g., 'provision_profiles.*'). The extension's own section is always included.",
              "examples": [["provision_profiles.*", "sdk.compile.tegraflash"]]
            }
          },
          "required": ["type", "version"],
          "additionalProperties": false
        },
        {
          "type": "object",
          "title": "Git source",
          "description": "Extension from a git repository.",
          "properties": {
            "type": {
              "type": "string",
              "enum": ["git"],
              "description": "Source type: git repository."
            },
            "url": {
              "type": "string",
              "description": "Git repository URL.",
              "examples": ["https://github.com/avocado-linux/extensions.git"]
            },
            "ref": {
              "type": "string",
              "description": "Git ref (branch, tag, or commit hash).",
              "examples": ["main", "v1.0.0", "abc123"]
            },
            "sparse_checkout": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Optional sparse checkout paths.",
              "examples": [["extensions/my-ext"]]
            },
            "include": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Optional list of config sections to include from the remote extension.",
              "examples": [["provision_profiles.*"]]
            }
          },
          "required": ["type", "url"],
          "additionalProperties": false
        },
        {
          "type": "object",
          "title": "Path source",
          "description": "Extension from a local filesystem path.",
          "properties": {
            "type": {
              "type": "string",
              "enum": ["path"],
              "description": "Source type: local filesystem path."
            },
            "path": {
              "type": "string",
              "description": "Path to the extension directory (relative to config or absolute).",
              "examples": ["../extensions/my-ext", "/opt/extensions/my-ext"]
            },
            "include": {
              "type": "array",
              "items": { "type": "string" },
              "description": "Optional list of config sections to include from the extension.",
              "examples": [["sdk.compile.*"]]
            }
          },
          "required": ["type", "path"],
          "additionalProperties": false
        }
      ]
    },
    "runtimeConfig": {
      "title": "Runtime configuration",
      "type": "object",
      "description": "Configuration for a runtime deployment scenario.",
      "properties": {
        "target": {
          "type": "string",
          "description": "Target platform for this runtime (overrides default_target)."
        },
        "extensions": {
          "title": "Extensions",
          "type": "array",
          "items": { "type": "string" },
          "description": "List of extension names to include in this runtime. Extensions must be defined in the 'extensions' section.",
          "examples": [["avocado-ext-dev", "avocado-ext-sshd-dev"]]
        },
        "packages": {
          "title": "Packages",
          "$ref": "#/definitions/packages",
          "description": "Package dependencies for this runtime."
        },
        "stone_include_paths": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Additional stone include paths for this runtime."
        },
        "stone_manifest": {
          "type": "string",
          "description": "Path to a custom stone manifest file."
        },
        "signing": {
          "$ref": "#/definitions/signingConfig",
          "description": "Signing configuration for this runtime."
        }
      },
      "additionalProperties": true
    },
    "signingConfig": {
      "title": "Signing configuration",
      "type": "object",
      "description": "Configuration for image signing.",
      "properties": {
        "key": {
          "type": "string",
          "description": "Name of the signing key to use (references a key from signing_keys section).",
          "examples": ["my-key"]
        },
        "checksum_algorithm": {
          "type": "string",
          "enum": ["sha256", "blake3"],
          "default": "sha256",
          "description": "Checksum algorithm to use for signing."
        }
      },
      "required": ["key"],
      "additionalProperties": false
    },
    "sdkConfig": {
      "type": "object",
      "description": "SDK configuration for building Avocado OS projects. Supports target-specific overrides using target names as keys.",
      "allOf": [
        {
          "$ref": "#/definitions/targetSdkConfig"
        },
        {
          "type": "object",
          "patternProperties": {
            "^[a-zA-Z0-9_-]+$": {
              "$ref": "#/definitions/targetSdkConfig"
            }
          }
        }
      ]
    },
    "targetSdkConfig": {
      "type": "object",
      "description": "SDK configuration for building Avocado OS projects.",
      "properties": {
        "image": {
          "title": "Docker image",
          "type": "string",
          "description": "Docker image to use for the SDK build environment. This provides the toolchain and build tools necessary for compilation.",
          "examples": ["avocado/sdk:2.0"]
        },
        "packages": {
          "title": "Packages",
          "$ref": "#/definitions/packages",
          "description": "SDK-level packages required for building the project. These are installed in the build environment.",
          "examples": [
            {
              "cmake": "*",
              "make": ">=4.0"
            }
          ]
        },
        "compile": {
          "title": "Compile configurations",
          "type": "object",
          "description": "Compile configurations for specific extensions or components. Each entry defines how to build a particular extension.",
          "patternProperties": {
            "^[a-zA-Z0-9_-]+$": {
              "$ref": "#/definitions/compileConfig"
            }
          },
          "additionalProperties": false,
          "examples": [
            {
              "wifi": {
                "compile": "make",
                "packages": {
                  "libnl": "3.5.0"
                }
              }
            }
          ]
        },
        "repo_url": {
          "title": "Repository URL",
          "type": "string",
          "description": "URL of the repository containing SDK resources. Can be overridden with the AVOCADO_SDK_REPO_URL environment variable.",
          "examples": ["https://github.com/avocado-linux/sdk"]
        },
        "repo_release": {
          "title": "Repository release",
          "type": "string",
          "description": "Specific release/tag of the SDK repository to use. Can be overridden with the AVOCADO_SDK_REPO_RELEASE environment variable.",
          "examples": ["v2.0.0"]
        },
        "container_args": {
          "title": "Container arguments",
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Additional arguments to pass to the Docker container. Supports environment variable expansion using ${VAR_NAME} syntax.",
          "examples": [["--network", "host"]]
        },
        "disable_weak_dependencies": {
          "title": "Disable weak dependencies",
          "type": "boolean",
          "description": "Disable installation of weak dependencies when installing packages.",
          "default": false
        },
        "host_uid": {
          "title": "Host UID",
          "type": "integer",
          "description": "Host UID for bindfs permission translation (overrides libc::getuid())."
        },
        "host_gid": {
          "title": "Host GID",
          "type": "integer",
          "description": "Host GID for bindfs permission translation (overrides libc::getgid())."
        }
      },
      "additionalProperties": false
    },
    "compileConfig": {
      "title": "Compile configuration",
      "type": "object",
      "description": "Compilation configuration for a specific extension or component.",
      "properties": {
        "compile": {
          "title": "Compile command",
          "type": "string",
          "description": "Compile command or script to execute for building this component.",
          "examples": ["make", "./build.sh"]
        },
        "clean": {
          "title": "Clean command",
          "type": "string",
          "description": "Path to clean script relative to src_dir, executed during 'ext clean' command.",
          "examples": ["./clean.sh", "make clean"]
        },
        "packages": {
          "title": "Packages",
          "$ref": "#/definitions/packages",
          "description": "Build-time packages required for compiling this component.",
          "examples": [
            {
              "libnl": "3.5.0",
              "gcc": ">=9.0"
            }
          ]
        }
      },
      "additionalProperties": false
    },
    "provisionProfileConfig": {
      "title": "Provision profile configuration",
      "type": "object",
      "description": "Configuration for a provisioning profile used to deploy Avocado OS images to devices.",
      "properties": {
        "container_args": {
          "title": "Container arguments",
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Additional arguments to pass to the provisioning container. Supports environment variable expansion using ${VAR_NAME} syntax.",
          "examples": [
            ["--device", "/dev/ttyUSB0"],
            ["--privileged", "--network=host"]
          ]
        },
        "state_file": {
          "title": "State file",
          "type": "string",
          "description": "Path to state file relative to src_dir for persisting state between provision runs. Defaults to '.avocado/provision-{profile}.state' when not specified.",
          "examples": [".avocado/provision-dev.state"]
        }
      },
      "additionalProperties": true
    },
    "extensionConfig": {
      "title": "Extension configuration",
      "type": "object",
      "description": "Configuration for an Avocado OS extension (system extension or configuration extension). Extensions can be local (defined in this file) or remote (fetched from a source).",
      "properties": {
        "source": {
          "$ref": "#/definitions/extensionSource",
          "description": "Source configuration for remote extensions. If not specified, the extension is considered local and must be fully defined in this config."
        },
        "version": {
          "$ref": "#/definitions/version"
        },
        "types": {
          "title": "Extension types",
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["sysext", "confext"]
          },
          "description": "Extension types. 'sysext' for system extensions that provide system-level functionality, 'confext' for configuration extensions that provide configuration files.",
          "examples": [["sysext"], ["sysext", "confext"]]
        },
        "scopes": {
          "title": "Scopes",
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Extension scopes that define where the extension applies. Used to control which parts of the system the extension affects.",
          "examples": [["system"]]
        },
        "overlay": {
          "title": "Overlay directory",
          "type": "string",
          "description": "Path to the overlay directory containing files to be included in the extension. The value should be relative to the src_dir. These files will be overlaid onto the root filesystem.",
          "examples": ["./overlay"]
        },
        "enable_services": {
          "title": "Enable services",
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of systemd services to enable when the extension is active. Services must be available in the extension or base system.",
          "examples": [["sshd.socket", "my-service.service"]]
        },
        "modprobe": {
          "title": "Kernel modules",
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Kernel modules to load when the extension is active. Modules must be available in the kernel or provided by the extension.",
          "examples": [["overlay", "br_netfilter"]]
        },
        "packages": {
          "$ref": "#/definitions/packages",
          "description": "Package dependencies required by the extension. These will be installed when the extension is built or deployed."
        },
        "sdk": {
          "type": "object",
          "description": "SDK-specific configuration for building this extension.",
          "properties": {
            "packages": {
              "$ref": "#/definitions/packages",
              "description": "Build-time packages specific to this extension.",
              "examples": [
                {
                  "nativesdk-rust": "*",
                  "rust-cross-canadian-aarch64": "*",
                  "nativesdk-cargo": "*"
                }
              ]
            }
          },
          "additionalProperties": true
        },
        "users": {
          "type": "object",
          "description": "User accounts to create or configure when the extension is active.",
          "patternProperties": {
            "^[a-zA-Z0-9_-]+$": {
              "$ref": "#/definitions/userConfig"
            }
          },
          "additionalProperties": false,
          "examples": [
            {
              "root": {
                "password": ""
              }
            }
          ]
        },
        "groups": {
          "type": "object",
          "description": "Groups to create or configure when the extension is active.",
          "patternProperties": {
            "^[a-zA-Z0-9_-]+$": {
              "$ref": "#/definitions/groupConfig"
            }
          },
          "additionalProperties": false,
          "examples": [
            {
              "docker": {
                "gid": 999
              }
            }
          ]
        }
      },
      "additionalProperties": true
    },
    "userConfig": {
      "type": "object",
      "description": "Configuration for a user account.",
      "properties": {
        "password": {
          "type": "string",
          "description": "User password. Use empty string for no password (passwordless). For security, consider using password hashes instead of plain text.",
          "examples": [""]
        },
        "shell": {
          "type": "string",
          "description": "User's login shell. Must be a valid shell available in the system.",
          "examples": ["/bin/bash"]
        },
        "home": {
          "type": "string",
          "description": "User's home directory path. Will be created if it doesn't exist.",
          "examples": ["/home/developer"]
        },
        "groups": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of groups the user belongs to. Groups must exist or be defined in the extension.",
          "examples": [["wheel", "docker"]]
        }
      },
      "additionalProperties": false
    },
    "groupConfig": {
      "type": "object",
      "description": "Configuration for a system group.",
      "properties": {
        "gid": {
          "type": "integer",
          "description": "Group ID (GID). Should be unique across the system. Consider using IDs above 1000 for user groups.",
          "minimum": 0,
          "maximum": 65535,
          "examples": [999]
        }
      },
      "additionalProperties": false
    },
    "packages": {
      "title": "Packages",
      "type": "object",
      "description": "Object defining package dependencies with version constraints.",
      "patternProperties": {
        "^[a-zA-Z0-9_.-]+$": {
          "description": "Package name with version constraint. Can be a simple version string or an object with additional configuration.",
          "oneOf": [
            {
              "$ref": "#/definitions/version"
            },
            {
              "type": "object",
              "description": "Advanced package configuration.",
              "properties": {
                "compile": {
                  "type": "string",
                  "description": "Reference to a compile configuration section in sdk.compile.",
                  "examples": ["my-app"]
                },
                "install": {
                  "type": "string",
                  "description": "Path to an install script for this package.",
                  "examples": ["install.sh"]
                }
              },
              "additionalProperties": true
            }
          ]
        }
      },
      "additionalProperties": false,
      "examples": [
        {
          "avocado-runtime": "*"
        },
        {
          "avocado-img-bootfiles": "*",
          "avocado-img-rootfs": "*",
          "avocado-img-initramfs": "*"
        }
      ]
    }
  },
  "examples": [
    {
      "default_target": "jetson-orin-nano-devkit",
      "supported_targets": ["raspberrypi4", "qemuarm64"],
      "src_dir": "src",
      "distro": {
        "channel": "stable",
        "version": "1.0.0"
      },
      "sdk": {
        "image": "avocado/sdk:2.0",
        "packages": {
          "cmake": "*"
        },
        "compile": {
          "wifi": {
            "compile": "make",
            "clean": "./clean.sh",
            "packages": {
              "libnl": "*"
            }
          }
        }
      },
      "runtimes": {
        "dev": {
          "extensions": ["avocado-ext-dev", "wifi"],
          "packages": {
            "avocado-img-bootfiles": "*",
            "avocado-img-rootfs": "*"
          }
        }
      },
      "provision_profiles": {
        "development": {
          "container_args": ["--device", "/dev/ttyUSB0"]
        }
      },
      "extensions": {
        "avocado-ext-dev": {
          "source": {
            "type": "package",
            "version": "*"
          }
        },
        "avocado-bsp-{{ avocado.target }}": {
          "source": {
            "type": "package",
            "version": "*",
            "include": ["provision_profiles.*"]
          }
        },
        "wifi": {
          "types": ["sysext"],
          "overlay": "./extensions/wifi/overlay",
          "packages": {
            "wifi-driver": {
              "compile": "wifi",
              "install": "install-wifi.sh"
            }
          },
          "sdk": {
            "packages": {
              "nativesdk-gcc": "*"
            }
          }
        },
        "my-local-ext": {
          "source": {
            "type": "path",
            "path": "../extensions/my-ext"
          }
        }
      }
    }
  ]
}
